---
title: "concordância-governo-partidos"
author: "Rodolfo Viana"
date: "22-10-2015"
output: html_document
---

Definições importantes para essa análise

* Fidelidade partidária é quantos dos deputados votaram de acordo com seu partido num período. 
* Concordância de um partido com outro é o quanto eles concordaram na recomendação durante um período. 
* Concordância de deputados com um partido é o quanto um conjunto de deputados votou de acordo com as recomendacoes de um partido

Bibliotecas necessárias 

```{r}
library(ggplot2)
library(dplyr)
require(scales)

source("R/camara-lib.R")
```

Carregando CSV com os votos dos deputados

```{r}
votos <- ler_votos_de_ativos("dados/votacoes.csv", corrigir_migracoes = FALSE)

# distinguir diferentes votações de uma mesma proposição
votos$num_pro <- paste0(votos$num_pro, "-", votos$id_votacao)

votos$pro_orientacao <- paste0(votos$num_pro, "-", votos$orientacao_partido)
votos$votos_dep <- paste0(votos$num_pro, "-", votos$voto, "-", votos$id_dep)

votos$orientacao_dep <- paste0(votos$num_pro, "-", votos$orientacao_partido, "-", votos$id_dep)

votos$ano_mes <- paste0(as.numeric(format(as.Date(votos$data, format = "%d/%m/%Y"),'%Y')), "", as.numeric(format(as.Date(votos$data, format = "%d/%m/%Y"),'%m'))) 
votos$ano <- as.numeric(format(as.Date(votos$data, format = "%d/%m/%Y"),'%Y'))
votos <- filter(votos, ano >= 2015)
```

Orientação de cada partido para cada votação

```{r}
orientacao_partidos <- unique(votos[,c("ano_mes", "partido", "pro_orientacao")])

orientacao_pt <- orientacao_partidos %>%
  filter(partido == "pt")

orientacao_pmdb <- orientacao_partidos %>%
  filter(partido == "pmdb")

orientacao_psdb <- orientacao_partidos %>%
  filter(partido == "psdb")

orientacao_psol <- orientacao_partidos %>%
  filter(partido == "psol")

orientacao_ptn <- orientacao_partidos %>%
  filter(partido == "ptn")

orientacao_pp <- orientacao_partidos %>%
  filter(partido == "pp")

orientacao_pr <- orientacao_partidos %>%
  filter(partido == "pr")

x <- filter(votos, partido == "pmdb")
```

Comparação da orientação do governo com a orientação dos outros partidos. 

```{r}
pmdb <- concordancia(orientacao_pt$pro_orientacao, orientacao_pmdb$pro_orientacao)
psdb <- concordancia(orientacao_pt$pro_orientacao, orientacao_psdb$pro_orientacao)
psol <- concordancia(orientacao_pt$pro_orientacao, orientacao_psol$pro_orientacao)

concordancia_governo <- data.frame(Concordancia = c(pmdb, psdb, psol), Partidos = c("pmdb", "psdb", "psol"))

p <- ggplot(data = concordancia_governo, aes(x=reorder(Partidos, -Concordancia), y = Concordancia)) + 
  geom_bar(stat="identity") + 
  labs(y='Concordância com o Governo', x='Partidos') +
  theme_classic() +
   theme(panel.background=element_blank())

png("plot/fidelidade/concordancia_governo_partidos.png", width = 800, height = 600)
p
dev.off()
```

Comparação da orientação dos partidos com o que os deputados realmente votaram

```{r}
votos_ptn <- filter(votos, partido == "ptn",  voto == "sim" | voto == "não", 
                   orientacao_partido == "sim" | orientacao_partido == "não")

votos_pp <- filter(votos, partido == "pp",  voto == "sim" | voto == "não", 
                   orientacao_partido == "sim" | orientacao_partido == "não")

votos_pr <- filter(votos, partido == "pr",  voto == "sim" | voto == "não", 
                   orientacao_partido == "sim" | orientacao_partido == "não")

votos_psol <- filter(votos, partido == "psol",  voto == "sim" | voto == "não", 
                   orientacao_partido == "sim" | orientacao_partido == "não")

votos_pt <- filter(votos, partido == "pt",  voto == "sim" | voto == "não", 
                   orientacao_partido == "sim" | orientacao_partido == "não")

votos_pmdb <- filter(votos, partido == "pmdb",  voto == "sim" | voto == "não", 
                   orientacao_partido == "sim" | orientacao_partido == "não")

votos_psdb <- filter(votos, partido == "psdb",  voto == "sim" | voto == "não", 
                   orientacao_partido == "sim" | orientacao_partido == "não")

pr <- concordancia(votos_pr$orientacao_dep, votos_pr$votos_dep)
pp <- concordancia(votos_pp$orientacao_dep, votos_pp$votos_dep)
ptn <- concordancia(votos_ptn$orientacao_dep, votos_ptn$votos_dep)

psol <- concordancia(votos_psol$orientacao_dep, votos_psol$votos_dep)
pt <- concordancia(votos_pt$orientacao_dep, votos_pt$votos_dep)
pmdb <- concordancia(votos_pmdb$orientacao_dep, votos_pmdb$votos_dep)
psdb <- concordancia(votos_psdb$orientacao_dep, votos_psdb$votos_dep)

fidelidade_partidaria <- data.frame(Concordancia = c(pmdb, pt, psol, pr, pp, ptn, psdb), Partidos = c("pmdb", "pt", "psol", "pr", "pp", "ptn", "psdb"))

p <- ggplot(data = fidelidade_partidaria, aes(x=reorder(Partidos, -Concordancia), y = Concordancia)) + 
  geom_bar(stat="identity") + 
  labs(y='Fidelidade dos partidos', x='Partidos') +
  theme_classic() +
   theme(panel.background=element_blank())

png("plot/fidelidade/fidelidade_partidaria.png", width = 800, height = 600)
p
dev.off()
```



Comparação entre o governo e outros partidos mês a mês 

```{r}
partidoA <- orientacao_pt
partidoB <- orientacao_pmdb
concordancia_mes <- function(partidoA, partidoB){
  df <- data.frame()

  if(length(partidoA) > length(partidoB)){
    max_orientacoes <- partidoA
  } else {
    max_orientacoes <- partidoB
  }
  
  data <- unique(max_orientacoes$ano_mes)
  
  for (m in data){
    partidoA_mes <-  partidoA %>%
      filter(ano_mes == 201512)
    
    partidoB_mes <-  partidoB %>%
      filter(ano_mes == 20159)
    
    
    df <- rbind(df, data.frame(Concordancia = concordancia(partidoA_mes$pro_orientacao, partidoB_mes$pro_orientacao), Mes = m))
  }
  df
}

pt_pmdb <- concordancia_mes(orientacao_pt, orientacao_pmdb)
pt_pmdb$partido <- "pmdb"

pt_psdb <- concordancia_mes(orientacao_pt, orientacao_psdb)
pt_psdb$partido <- "psdb"

pt_psol <- concordancia_mes(orientacao_pt, orientacao_psol)
pt_psol$partido <- "psol"  

plot <- rbind(pt_pmdb, pt_psdb, pt_psol)
plot$nome_mes <- month.abb[plot$Mes]

p <- ggplot(data = plot, aes(x=reorder(nome_mes, Mes), y = Concordancia, group=partido,  colour=partido)) + 
  geom_line() +
  geom_point() + 
    scale_colour_manual(values = c(alpha("darkred", 1), 
                                 alpha("#0066CC", 1),
                                 alpha("#E69F00", 1)), 
                      guide = guide_legend(title = "Partido", 
                                           override.aes = list(alpha = 1, size = 4))) +
  ylab("Concordância com o Governo") + xlab("Mês") +  
  facet_grid(partido ~ .) +
  theme_classic() + 
  theme(axis.ticks = element_blank())


ggplot(data = pt_pmdb, aes(x=reorder(Mes, Mes), y = Concordancia, group=partido)) + 
  geom_line() +
  geom_point() + 
  ylab("Concordância com o Governo") + xlab("Mês") +  
  theme_classic() + 
  theme(axis.ticks = element_blank())

png("plot/concordancia_mes_a_mes_2.png", 
    width = 800, height = 600)
p
dev.off()

# PAREI AQUI. CONTAR VOTAÇÕES POR MÊS
votos %>% group_by(mes) %>% mutate(votados = NROW(unique(num_pro)))
  
```

