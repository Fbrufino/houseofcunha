---
  title: "concordância-partidaria"
author: "Tarciso Braz"
date: "21-12-2015"
output: html_document
---
  
  
  Mostra qual o nível de concordância dos deputados com seus respectivos partidos. 

Bibliotecas necessárias 

```{r}
library(ggplot2)
library(dplyr)
require(scales)

source("R/camara-lib.R")
```

Carregando CSV com os votos dos deputados

```{r}
votos <- ler_votos_de_ativos("votacoes.csv", corrigir_migracoes = FALSE)

# distinguir diferentes votações de uma mesma proposição
votos$num_pro <- paste0(votos$num_pro, "-", votos$id_votacao)

votos$pro_orientacao <- paste0(votos$num_pro, "-", votos$orientacao_partido)

votos$mes <- as.numeric(format(as.Date(votos$data, format = "%d/%m/%Y"),'%m'))
votos$ano <- as.numeric(format(as.Date(votos$data, format = "%d/%m/%Y"),'%Y'))
votos <- filter(votos, ano >=2015)
```

Concordância por partido

```{r}

concordancia_partidaria_mes <- function(votos,sigla.partido,num.mes) {
  votos.partido.mes <- filter(votos,votos$partido == sigla.partido, votos$mes == num.mes)
  votos.partido.mes <- filter(votos.partido.mes,votos.partido.mes$orientacao_partido != "liberado" & votos.partido.mes$orientacao_partido != "NA")
  votos.concordancia <- filter(votos.partido.mes,as.character(votos.partido.mes$voto) == as.character(votos.partido.mes$orientacao_partido))
  
  total <- nrow(votos.partido.mes)
  conc <- nrow(votos.concordancia)
  
  return (if (total != 0) conc/total else NA)
}

concordancia_partidaria_meses <- function(votos,partido) {
  conc <- data.frame()
  
  meses <- c(2:11)
  
  for (num.mes in meses) {
    conc.mes <- list()
    conc.mes$part <- partido
    conc.mes$concordancia <- concordancia_partidaria_mes(votos,partido,num.mes)
    conc.mes$n.mes <- num.mes
    
    conc <- rbind(conc,conc.mes, make.row.names = FALSE)
  }
  
  conc
}

```

Partidos de destaque

```{r}

conc.pmdb <- concordancia_partidaria_meses(votos,"pmdb")
conc.psdb <- concordancia_partidaria_meses(votos,"psdb")
conc.pt <- concordancia_partidaria_meses(votos,"pt")
conc.psol <- concordancia_partidaria_meses(votos,"psol")

conc <- rbind(conc.pmdb, conc.psdb, conc.pt, conc.psol)
conc$nome_mes <- month.abb[conc$n.mes]

conc$nome_mes <- factor(conc$nome_mes, levels = month.abb[conc$n.mes][1:10])

ggplot(data=conc, aes(x=nome_mes, y=concordancia, group=part, colour=part)) +
    geom_line() +
    geom_point()

```

Todos os partidos

```{r}

conc <- data.frame()

for (p in unique(votos$partido)) {
  conc.partido <- concordancia_partidaria_meses(votos,p)
  conc <- rbind(conc,conc.partido)
}

conc$nome_mes <- month.abb[conc$n.mes]

conc$nome_mes <- factor(conc$nome_mes, levels = month.abb[conc$n.mes][1:10])

ggplot(data=conc, aes(x=nome_mes, y=concordancia, group=part, colour=part)) +
    geom_line() +
    geom_point()

```

Top Concordância por partido

```{r}

conc <- data.frame()

for (p in unique(votos$partido)) {
  conc.partido <- concordancia_partidaria_meses(votos,p)
  conc <- rbind(conc,conc.partido)
}

conc_por_partido <- aggregate(concordancia ~ part, conc, mean)
conc_por_partido <- conc_por_partido[order(conc_por_partido$concordancia,decreasing = TRUE),]

```

Concordância por deputado

```{r}

concordancia_partidaria_dep_mes <- function(votos,id.deputado,num.mes) {
  #id.deputado <- 191684
  #num.mes = 10
  votos.deputado.mes <- filter(votos,votos$id_dep == id.deputado, votos$mes == num.mes)
  votos.deputado.mes <- filter(votos.deputado.mes,votos.deputado.mes$orientacao_partido != "liberado" & votos.deputado.mes$orientacao_partido != "NA")
  votos.concordancia <- filter(votos.deputado.mes,as.character(votos.deputado.mes$voto) == as.character(votos.deputado.mes$orientacao_partido))
  
  total <- nrow(votos.deputado.mes)
  conc <- nrow(votos.concordancia)
  
  return (if (total != 0) conc/total else NA)
}

concordancia_partidaria_dep_meses <- function(votos,id.deputado) {
  conc <- data.frame()
  
  meses <- c(2:11)
  
  for (num.mes in meses) {
    conc.mes <- list()
    conc.mes$dep <- id.deputado
    conc.mes$concordancia <- concordancia_partidaria_dep_mes(votos,id.deputado,num.mes)
    conc.mes$n.mes <- num.mes
    
    conc <- rbind(conc,conc.mes, make.row.names = FALSE)
  }
  
  conc
}

```

Top Concordância por deputado

```{r}

conc <- data.frame()

for (d in unique(votos$id_dep)) {
  conc.deputado <- concordancia_partidaria_dep_meses(votos,d)
  conc <- rbind(conc,conc.deputado)
}

conc_por_deputado <- aggregate(concordancia ~ dep, conc, mean)
conc_por_deputado <- conc_por_deputado[order(conc_por_deputado$concordancia,decreasing = TRUE),]

