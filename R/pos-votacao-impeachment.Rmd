---
title: "pos-votacao-impeachment"
output: html_document
---

Análise sobre a votação do impeachment na câmara do deputados.

Carregando as bibliotecas necessárias

```{r}
require(FactoMineR)
library(ggplot2)
library(dplyr)
require(scales)
#install.packages('tm')
library(tm)

source("R/camara-lib.R")
```

Carregando os dados dos deputados e da votação do impeachment

```{r, warning=FALSE, message=FALSE, fig.align='center', echo=FALSE}
# Deputados votaçoes de 2015 ate abril de 2016
votos_por_deputado <- recuperar_votos_por_deputado(arquivo.votos = "dados/votacoes.csv", corrigir.migracoes = TRUE)

# Deputados votação impeachment
deputados.votacao.impeachment <- read.csv("~/Projetos/houseofcunha/dados/deputados-votacao-impeachment.csv", sep=";")

# Votação Impeachment Discursos
discursos.impeachment <- read.csv("~/Projetos/houseofcunha/dados/discursos impeachment.csv", stringsAsFactors = FALSE)
voto_impeachment <- select(discursos.impeachment, Deputado, Voto)
```


```{r, warning=FALSE, message=FALSE, fig.align='center', echo=FALSE}
mca <- MCA(votos_por_deputado, 
           ncp = 6, # Default is 5 
           graph = FALSE,
           quali.sup = c(1:4),
           na.method = "Average") # NA or Average

mca_obs_df <-  data.frame(mca$ind$coord, 
                           nome = votos_por_deputado$nome,
                           partido = votos_por_deputado$partido, 
                           uf = votos_por_deputado$uf,
                           id_dep = votos_por_deputado$id_dep)

mca_obs_df$id_dep <- as.integer(as.character(mca_obs_df$id_dep))

#Criação do clust
hcpc <- clusterizar(mca,4)
clusters <- obter_clusters(hcpc)

mca_obs_df <- cbind(mca_obs_df, select(clusters,clust))
mca_obs_df$clust <- as.factor(mca_obs_df$clust)

# Destaque da votação do impeachment 

colnames(deputados.votacao.impeachment)

deputados.votacao.impeachment2 <- deputados.votacao.impeachment[!duplicated(deputados.votacao.impeachment$id_dep), ]
deputados.votacao.impeachment3 <- filter(deputados.votacao.impeachment2, id_dep != 74213)

teste <- left_join(mca_obs_df, select(deputados.votacao.impeachment3, id_dep, IMPEACHMENT), by = "id_dep")

summary(teste$IMPEACHMENT)

X <- filter(teste, IMPEACHMENT == "SIM")
xx <- filter(imp.votacao, voto == "SIM")




mca_obs_df$impeachment <-  mca_obs_df$nome %in% voto_impeachment$Deputado

voto_impeachment$nomes <- voto_impeachment$Deputado  %in%  mca_obs_df$nome

voto_impeachment_false <- filter(voto_impeachment, nomes == FALSE)

teste <- left_join(mca_obs_df, voto_impeachment, by = c("nome" = "Deputado"))

x <- filter(mca_obs_df, impeachment == FALSE)
# sum(mca_obs_df$impeachment)
# y <- filter(mca_obs_df, impeachment == TRUE)

match_deputados <- function(nome.deputados.novo, nome.deputados.original){
  df <- data.frame()

  for (nome in nome.deputados.novo){
    novo_nome <- agrep(nome, nome.deputados.original, ignore.case=T, value=T, max.distance = 0.2, useBytes = FALSE)
    df <- rbind(df, data.frame(nome, ifelse(length(novo_nome) == 0, "NA", novo_nome)))
  }
  
  df
}

nome_deputados <- voto_impeachment_false$Deputado
nome_original <- mca_obs_df$nome

nome.deputados.novo <- nome_deputados
nome.deputados.original <- nome_original

p <- ggplot(data = teste, aes(x = Dim.1, y = Dim.2)) + 
   geom_point(data = teste, size = 9, alpha = 0.3, aes(colour = factor(Voto))) + 
  scale_colour_manual(values = c("red","blue", "green", "gray70", "black")) +
  theme_classic() + 
  theme(axis.ticks = element_blank()) 

png("plot/pos_votacao/mapa_sim_nao_impeachment.png", width = 900, height = 500)
p
dev.off()

levels(mca_obs_df$clust) <- c("Governo", "Alinhados com PMDB", "Oposição de esquerda", "Oposição")
```

Processamento dos discrusos da votação do impeachment na câmara (1 palavra)

```{r}
discursos.impeachment$Fala <- paste0(discursos.impeachment$Fala, " ", discursos.impeachment$X)
discursos.impeachment$X <- NULL

discursos.sim <- filter(discursos.impeachment, Voto == "Sim")
discursos.nao <- filter(discursos.impeachment, Voto == "Não")

frequencia.discursos.sim <- frequencia_palavra_discursos(discursos.sim, 1)
frequencia.discursos.nao <- frequencia_palavra_discursos(discursos.nao, 1)

toPlot <- create_destaque_columns(processamento_palavras_frequentes(frequencia.discursos.sim, frequencia.discursos.nao, 100), 20)

p <- ggplot(data = toPlot, aes(x = reorder(top, -top), y = reorder(top_nao, -top_nao))) + 
  geom_text(data = toPlot, 
                   aes(label = toupper(Palavra)),
                   colour = alpha("grey70", .4), alpha = 0.5, size = 5, hjust = -.15) + 
  geom_text(data = filter(toPlot, destaque == TRUE), 
                   aes(label =  toupper(Palavra)),
                   colour = "black", alpha = 0.5, size = 5, hjust = -.15) + 
  scale_x_discrete('Discurso SIM', breaks = c(max(toPlot$top),  median(toPlot$top), 1),
                     labels=c("base", "meio", "topo")) +
  scale_y_discrete('Discurso NAO', breaks = c(max(toPlot$top_nao), median(toPlot$top_nao), 1),
                     labels=c("base", "meio", "topo")) +
  geom_abline(intercept = 0, color = alpha("#762a83", 1)) +
  theme_classic() 

png("plot/pos_votacao_impeachment/mapa_1_palavra.png", 
    width = 800, height = 800)
p
dev.off()
```

Processamento dos discrusos da votação do impeachment na câmara (2 palavra)

```{r}
frequencia.discursos.sim <- frequencia_palavra_discursos(discursos.sim, 2)
frequencia.discursos.nao <- frequencia_palavra_discursos(discursos.nao, 2)

toPlot <- create_destaque_columns(processamento_palavras_frequentes(frequencia.discursos.sim, frequencia.discursos.nao, 100), 15)

p <- ggplot(data = toPlot, aes(x = reorder(top, -top), y = reorder(top_nao, -top_nao))) + 
  geom_text(data = toPlot, 
                   aes(label = toupper(Palavra)),
                   colour = alpha("grey70", .4), alpha = 0.5, size = 5, hjust = -.15) + 
  geom_text(data = filter(toPlot, destaque == TRUE), 
                   aes(label =  toupper(Palavra)),
                   colour = "black", alpha = 0.5, size = 5, hjust = -.15) + 
  scale_x_discrete('Discurso SIM', breaks = c(max(toPlot$top),  median(toPlot$top), 1),
                     labels=c("base", "meio", "topo")) +
  scale_y_discrete('Discurso NAO', breaks = c(max(toPlot$top_nao), median(toPlot$top_nao), 1),
                     labels=c("base", "meio", "topo")) +
  geom_abline(intercept = 0, color = alpha("#762a83", 1)) +
  theme_classic() 

png("plot/pos_votacao_impeachment/mapa_2_palavra.png", 
    width = 800, height = 800)
p
dev.off()
```

Processamento dos discrusos da votação do impeachment na câmara (3 palavra)

```{r}
frequencia.discursos.sim <- frequencia_palavra_discursos(discursos.sim, 3)
frequencia.discursos.nao <- frequencia_palavra_discursos(discursos.nao, 3)

toPlot <- create_destaque_columns(processamento_palavras_frequentes(frequencia.discursos.sim, frequencia.discursos.nao, 100), 10)

p <- ggplot(data = toPlot, aes(x = reorder(top, -top), y = reorder(top_nao, -top_nao))) + 
  geom_text(data = toPlot, 
                   aes(label = toupper(Palavra)),
                   colour = alpha("grey70", .4), alpha = 0.5, size = 5, hjust = -.15) + 
  geom_text(data = filter(toPlot, destaque == TRUE), 
                   aes(label =  toupper(Palavra)),
                   colour = "black", alpha = 0.5, size = 5, hjust = -.15) + 
  scale_x_discrete('Discurso SIM', breaks = c(max(toPlot$top),  median(toPlot$top), 1),
                     labels=c("base", "meio", "topo")) +
  scale_y_discrete('Discurso NAO', breaks = c(max(toPlot$top_nao), median(toPlot$top_nao), 1),
                     labels=c("base", "meio", "topo")) +
  geom_abline(intercept = 0, color = alpha("#762a83", 1)) +
  theme_classic() 

png("plot/pos_votacao_impeachment/mapa_3_palavra.png", 
    width = 800, height = 800)
p
dev.off()
```